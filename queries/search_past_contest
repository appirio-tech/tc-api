SELECT 
SKIP @fri@
FIRST @ps@
  projectCategory.description AS type 
, projectCatalog.name AS catalog  
, NVL(nRegistrants.count, 0) AS numberOfRegistrants
, NVL(nSubmissions.count, 0) AS numberOfSubmissions
, NVL(nScreens.count, 0) AS passedScreeningCount
, NVL(phase.finalReviewEndDate, phase.reviewEndDate) AS completionDate
, projectInfo.projectName AS contestName 
, project.project_id AS contestId 
, project.tc_direct_project_id AS projectId 
, projectCategory.project_type_id as projectType
, phase.submissionEndDate AS submissionEndDate 
, phase.registrationStartDate AS registrationStartDate
, phase.registrationEndDate AS registrationEndDate
, ratedReg.ctn AS numberOfUnratedRegistrants
, ratedReg.ctn AS numberOfRatedRegistrants
, prizes.prize1 as firstprize
, prizes.prize1
, prizes.prize1 * 0.2 as reliabilityBonus
, prizes.prize1
, prizes.prize2
, prizes.prize3
, prizes.prize4
, prizes.prize5
, prizes.prize6
, prizes.prize7
, prizes.prize8
, not exists (select * from project_info pi45 where pi45.project_info_type_id=45 and pi45.project_id=project.project_id and (pi45.value='false' or pi45.value='False')) AS reliability_bonus_eligible
, CAST((CASE WHEN digitalRunFlagInfo.value = 'On' THEN NVL((SELECT value FROM project_info pi_dr WHERE pi_dr.project_info_type_id = 30 AND pi_dr.project_id = project.project_id), (SELECT round(nvl(pi16.value, 0)) FROM project_info pi16 WHERE pi16.project_info_type_id = 16 AND pi16.project_id = project.project_id)) ELSE '0' END) AS float) AS digitalRunPoints
, cmc.value as cmc
 FROM  
  project 
JOIN ( 
  SELECT 
  project_id, 
  max(DECODE(project_info_type_id, 6, value, NULL)) AS projectName
  FROM 
  project_info pi 
  WHERE 
  pi.project_info_type_id IN (6) 
  GROUP BY project_id 
) projectInfo ON projectInfo.project_id = project.project_id 
JOIN project_category_lu projectCategory ON project.project_category_id = projectCategory.project_category_id AND projectCategory.project_type_id IN (1, 2, 3) 
  LEFT JOIN project_catalog_lu projectCatalog ON projectCategory.project_catalog_id = projectCatalog.project_catalog_id 
LEFT JOIN ( 
  SELECT  
    project_id,  
    max(DECODE(phase_type_id, 1, scheduled_start_time, NULL)) AS registrationStartDate,
    max(DECODE(phase_type_id, 1, scheduled_end_time, NULL)) AS registrationEndDate,
    max(DECODE(phase_type_id, 2, scheduled_end_time, NULL)) AS submissionEndDate,
    max(DECODE(phase_type_id, 4, scheduled_end_time, NULL)) AS reviewEndDate, 
    max(DECODE(phase_type_id, 10, scheduled_end_time, NULL)) AS finalReviewEndDate
  FROM  
    project_phase tpp 
  WHERE  
    tpp.phase_type_id IN (1, 2, 4, 10) 
  GROUP BY project_id 
) phase ON phase.project_id = project.project_id
LEFT JOIN (SELECT project_id, count(*) AS ctn from resource WHERE resource_role_id = 1  GROUP BY project_id ) ratedReg on ratedReg.project_id = project.project_id
LEFT JOIN ( 
  SELECT 
    up.project_id AS project_id,  
    u1.handle_lower AS winnerHandle 
  FROM upload up 
  INNER JOIN submission sub ON sub.upload_id = up.upload_id 
  INNER JOIN resource_info ri_user ON up.resource_id = ri_user.resource_id 
  INNER JOIN user u1 ON ri_user.value = u1.user_id 
  WHERE  
   ri_user.resource_info_type_id = 1  
   AND sub.placement = 1 
   AND sub.submission_type_id = 1 
) winnerHandleTable ON winnerHandleTable.project_id = project.project_id 
LEFT JOIN ( 
  SELECT 
    up.project_id AS project_id,  
    sub.final_score AS winnerScore 
  FROM upload up 
  INNER JOIN submission sub ON sub.upload_id = up.upload_id  
  WHERE  
    sub.placement = 1 
    AND sub.submission_type_id = 1 
) winnerScoreTable ON winnerScoreTable.project_id = project.project_id 
LEFT JOIN ( 
  SELECT  
  COUNT(*) AS count, 
  u1.project_id AS project_id 
  FROM submission s1  
  INNER JOIN upload u1 ON s1.upload_id = u1.upload_id 
  WHERE  
  s1.submission_status_id IN (1,4) 
  AND s1.submission_type_id IN (1, 3) 
  GROUP BY project_id 
) nScreens ON nScreens.project_id = project.project_id 
LEFT JOIN ( 
  SELECT  
  COUNT(*) AS count, 
  u.project_id AS project_id 
  FROM submission s, upload u   
  WHERE u.upload_id = s.upload_id 
  AND s.submission_type_id IN (1, 3) 
  AND s.submission_status_id IN (1,2,3,4,6,7) 
  GROUP BY project_id 
) nSubmissions ON nSubmissions.project_id = project.project_id 
LEFT JOIN ( 
  SELECT  
  COUNT(*) AS count,  
  project_id  
  FROM resource  
  WHERE resource_role_id = 1 
  GROUP BY project_id 
) nRegistrants ON nRegistrants.project_id = project.project_id 

LEFT JOIN (
    select project_id
    , max(case when place = 1 then prize_amount else -1 end) as prize1
    , max(case when place = 2 then prize_amount else -1 end) as prize2
    , max(case when place = 3 then prize_amount else -1 end) as prize3
    , max(case when place = 4 then prize_amount else -1 end) as prize4
    , max(case when place = 5 then prize_amount else -1 end) as prize5
    , max(case when place = 6 then prize_amount else -1 end) as prize6
    , max(case when place = 7 then prize_amount else -1 end) as prize7
    , max(case when place = 8 then prize_amount else -1 end) as prize8 
    from prize where prize_type_id = 15 group by project_id) prizes ON project.project_id = prizes.project_id       
LEFT JOIN project_info cmc ON cmc.project_Id = project.project_id AND cmc.project_info_type_id = 70
,project_info digitalRunFlagInfo
 WHERE   
  project.project_status_id IN (4, 5, 7)  
  AND projectCategory.project_type_id IN (@project_type_id@)
  AND digitalRunFlagInfo.project_id = project.project_id
  AND digitalRunFlagInfo.project_info_type_id = 26
  AND project.project_category_id not IN (27) 
  AND NOT EXISTS (
       SELECT 1 FROM contest_eligibility ce 
       JOIN group_contest_eligibility gce on gce.contest_eligibility_id = ce.contest_eligibility_id   
       WHERE ce.contest_id = project.project_id AND gce.group_id = 218)
  AND LOWER(projectInfo.projectName) LIKE ('@pjn@')
  AND EXTEND(phase.registrationStartDate, year to day) <= '@registstartend@'
  AND EXTEND(phase.registrationStartDate, year to day) >= '@registstartstart@'
  AND EXTEND(phase.submissionEndDate, year to day) <= '@subendend@'
  AND EXTEND(phase.submissionEndDate, year to day) >= '@subendstart@'
  AND NVL(prizes.prize1, 0) >= @prilower@
  AND NVL(prizes.prize1, 0) <= @priupper@
  AND project.tc_direct_project_id = DECODE(@tcdirectid@, 0, project.tc_direct_project_id, @tcdirectid@)
  AND NVL(LOWER(winnerHandleTable.winnerHandle), '') LIKE '@hn@'
  AND EXTEND(NVL(phase.finalReviewEndDate, phase.reviewEndDate), year to day) <= '@frendend@'
  AND EXTEND(NVL(phase.finalReviewEndDate, phase.reviewEndDate), year to day) >= '@frendstart@'
  AND LOWER(projectCategory.description) = DECODE('@ctn@', '', LOWER(projectCategory.description), '@ctn@')
  AND NVL(LOWER(projectCatalog.name), '') = DECODE('@catalog@', '', NVL(LOWER(projectCatalog.name), ''), '@catalog@')
  AND NVL(LOWER(cmc.value), '') = DECODE('@cmc@', '', NVL(LOWER(cmc.value), ''), '@cmc@')
ORDER BY @sf@ @sd@
